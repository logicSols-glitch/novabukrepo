<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>NovaBuk Blog Admin Dashboard</title>
    <!--
      Optional: include Cloudinary cloud name for client-side fallback.
      Add this meta only for development/testing; cloud name is public.
      Example: <meta name="cloudinary-cloud-name" content="dwp8bq3dw">
    -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #f5f7fa;
        color: #333;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background: linear-gradient(135deg, #7ecad7, #35bac9);
        color: white;
        padding: 20px;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .sidebar-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 15px;
      }

      .sidebar-header h2 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .sidebar-header p {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .sidebar-menu {
        list-style: none;
      }

      .sidebar-menu li {
        margin-bottom: 10px;
      }

      .sidebar-menu a {
        display: block;
        padding: 12px 15px;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background: rgba(255, 255, 255, 0.2);
        padding-left: 20px;
      }

      .sidebar-menu a i {
        margin-right: 10px;
        width: 20px;
      }

      .logout-btn {
        margin-top: 30px;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Main Content */
      .main-content {
        margin-left: 250px;
        flex: 1;
        padding: 30px;
      }

      /* Prevent horizontal overflow and ensure images scale */
      body {
        overflow-x: hidden;
      }

      .main-content img,
      #uploadPreview img,
      #uploadPreview video {
        max-width: 100%;
        height: auto;
        display: block;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .header h1 {
        font-size: 2rem;
        color: #1a1a1a;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #7ecad7, #35bac9);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(53, 186, 201, 0.3);
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      /* Forms */
      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #1a1a1a;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #35bac9;
      }

      textarea {
        resize: vertical;
        min-height: 300px;
      }

      /* Tables */
      .table-responsive {
        background: white;
        border-radius: 12px;
        overflow-x: auto;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #eee;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .status-published {
        background: #d4edda;
        color: #155724;
      }

      .status-draft {
        background: #fff3cd;
        color: #856404;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        color: #1a1a1a;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #888;
      }

      .close-btn:hover {
        color: #1a1a1a;
      }

      /* Alerts */
      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        display: none;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert.show {
        display: block;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Login Page */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #7ecad7, #35bac9);
      }

      .login-box {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 400px;
      }

      .login-box h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #1a1a1a;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .grid-full {
        grid-column: 1 / -1;
      }

      @media (max-width: 768px) {
        html,
        body {
          overflow-x: hidden;
          width: 100%;
        }
        #dashboard {
          flex-direction: row;
        }
        .sidebar {
          width: 50%;
          max-width: 320px;
          height: 100vh;
          position: fixed;
          left: 0;
          top: 0;
          display: none;
          z-index: 2100;
          background: linear-gradient(135deg, #7ecad7, #35bac9);
          box-shadow: 0 6px 30px rgba(0, 0, 0, 0.35);
        }

        /* When the sidebar has the open class it becomes visible on mobile */
        .sidebar.open {
          display: block;
        }

        /* A translucent overlay shown when sidebar is open */
        .sidebar-overlay {
          display: none;
        }

        .sidebar-overlay.active {
          display: block;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.45);
          z-index: 2000;
        }

        .main-content {
          margin-left: 0;
          padding: 16px;
        }

        /* Reduce modal max width on small screens */
        .modal-content {
          width: 95%;
          padding: 18px;
        }

        /* Tables: make cells wrap and keep table scrollable */
        .table-responsive table td,
        .table-responsive table th {
          word-break: break-word;
          white-space: normal;
        }

        .header {
          flex-direction: column;
          gap: 15px;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }

        table {
          font-size: 0.9rem;
        }

        td,
        th {
          padding: 10px;
        }
      }

      .hidden {
        display: none;
      }

      .loader {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #35bac9;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .action-buttons .btn {
        padding: 6px 12px;
        font-size: 0.9rem;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container hidden">
      <div class="login-box">
        <h2>NovaBuk Blog Admin</h2>
        <div id="loginAlert" class="alert"></div>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input
              type="email"
              id="loginEmail"
              required
              placeholder="admin@novabuk.com"
            />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input
              type="password"
              id="loginPassword"
              required
              placeholder="••••••••"
            />
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Login
          </button>
          <p style="text-align: center; margin-top: 15px; color: #888">
            First time?
            <a
              href="#"
              id="registerToggle"
              style="color: #35bac9; cursor: pointer"
              >Create Admin Account</a
            >
          </p>
        </form>

        <form id="registerForm" class="hidden" style="margin-top: 30px">
          <h3 style="margin-bottom: 20px">Create Admin Account</h3>
          <div class="form-group">
            <label for="registerName">Name:</label>
            <input
              type="text"
              id="registerName"
              required
              placeholder="Your Name"
            />
          </div>
          <div class="form-group">
            <label for="registerEmail">Email:</label>
            <input
              type="email"
              id="registerEmail"
              required
              placeholder="admin@novabuk.com"
            />
          </div>
          <div class="form-group">
            <label for="registerPassword">Password:</label>
            <input
              type="password"
              id="registerPassword"
              required
              placeholder="••••••••"
              minlength="6"
            />
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Create Account
          </button>
          <p style="text-align: center; margin-top: 15px; color: #888">
            Already have account?
            <a href="#" id="loginToggle" style="color: #35bac9; cursor: pointer"
              >Login</a
            >
          </p>
        </form>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container hidden">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>NovaBuk</h2>
          <p>Blog Admin</p>
        </div>
        <ul class="sidebar-menu">
          <li>
            <a href="#" onclick="showSection('blogs')" class="menu-link active"
              ><i class="fas fa-newspaper"></i> Blog Posts</a
            >
          </li>
          <li>
            <a
              href="#"
              onclick="
                editingBlogId = null;
                showSection('createBlog');
              "
              class="menu-link"
              ><i class="fas fa-plus"></i> New Post</a
            >
          </li>
          <li>
            <a href="#" onclick="showSection('profile')" class="menu-link"
              ><i class="fas fa-user"></i> Profile</a
            >
          </li>
        </ul>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </aside>

      <div
        id="sidebarOverlay"
        class="sidebar-overlay"
        onclick="closeSidebarOnOverlay()"
      ></div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <div class="header">
          <button
            id="sidebarToggle"
            aria-label="Toggle sidebar"
            class="nav-toggle"
          >
            <i class="fas fa-bars"></i>
          </button>
          <h1 id="pageTitle">Blog Posts</h1>
          <button
            class="btn btn-primary"
            onclick="
              editingBlogId = null;
              showSection('createBlog');
            "
          >
            <i class="fas fa-plus"></i> New Post
          </button>
        </div>

        <div id="alertContainer"></div>

        <!-- Blogs Section -->
        <section id="blogsSection">
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Published</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="blogsTable">
                <tr>
                  <td colspan="5" class="loader">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Create/Edit Blog Section -->
        <section id="createBlogSection" class="hidden">
          <div
            style="
              background: white;
              padding: 30px;
              border-radius: 12px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            "
          >
            <h2 id="formTitle">Create New Blog Post</h2>
            <form id="blogForm" style="margin-top: 20px">
              <input type="hidden" id="blogId" />

              <div class="form-group">
                <label for="blogTitle">Title:</label>
                <input
                  type="text"
                  id="blogTitle"
                  required
                  placeholder="Blog title"
                />
              </div>

              <div class="grid-2">
                <div class="form-group">
                  <label for="blogCategory">Category:</label>
                  <select id="blogCategory" required>
                    <option value="">Select Category</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="technology">Technology</option>
                    <option value="innovation">Innovation</option>
                    <option value="tips">Tips & Guides</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="blogReadTime">Read Time (minutes):</label>
                  <input type="number" id="blogReadTime" value="5" min="1" />
                </div>
              </div>

              <div class="form-group">
                <label for="blogExcerpt">Excerpt (Summary):</label>
                <textarea
                  id="blogExcerpt"
                  placeholder="Brief summary of the blog post"
                  style="min-height: 80px"
                ></textarea>
              </div>

              <div class="form-group">
                <label for="blogContent">Content:</label>
                <textarea
                  id="blogContent"
                  required
                  placeholder="Write your blog content here..."
                ></textarea>
              </div>

              <div class="grid-2">
                <div class="form-group">
                  <label for="blogAuthor">Author:</label>
                  <input
                    type="text"
                    id="blogAuthor"
                    value="NovaBuk Team"
                    placeholder="Author name"
                  />
                </div>

                <div class="form-group">
                  <label for="blogAuthorRole">Author Role:</label>
                  <input
                    type="text"
                    id="blogAuthorRole"
                    value="Content Team"
                    placeholder="Author's role"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="blogFile">Upload Image / Video:</label>
                <input type="file" id="blogFile" accept="image/*,video/*" />
                <div id="uploadPreview" style="margin-top: 10px"></div>
                <div id="uploadProgress" style="display: none; margin-top: 8px">
                  <progress
                    id="uploadProgressBar"
                    value="0"
                    max="100"
                    style="width: 100%"
                  ></progress>
                </div>
                <input
                  type="hidden"
                  id="blogImage"
                  value="./images/image 34.png"
                />
              </div>

              <div class="grid-2">
                <button type="submit" class="btn btn-primary">
                  Save Draft
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="saveBlogAndPublish()"
                >
                  Save & Publish
                </button>
              </div>

              <button
                type="button"
                class="btn btn-secondary"
                onclick="showSection('blogs')"
                style="margin-top: 10px; width: 100%"
              >
                Cancel
              </button>
            </form>
          </div>
        </section>

        <!-- Profile Section -->
        <section id="profileSection" class="hidden">
          <div
            style="
              background: white;
              padding: 30px;
              border-radius: 12px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
              max-width: 600px;
            "
          >
            <h2>Admin Profile</h2>
            <form id="profileForm" style="margin-top: 20px">
              <div class="form-group">
                <label for="profileName">Name:</label>
                <input type="text" id="profileName" required />
              </div>

              <div class="form-group">
                <label for="profileEmail">Email:</label>
                <input type="email" id="profileEmail" required />
              </div>

              <div class="form-group">
                <label for="profileRole">Role:</label>
                <input type="text" id="profileRole" disabled />
              </div>

              <hr style="margin: 30px 0" />

              <h3>Change Password</h3>

              <div class="form-group">
                <label for="currentPassword">Current Password:</label>
                <input
                  type="password"
                  id="currentPassword"
                  placeholder="••••••••"
                  minlength="6"
                />
              </div>

              <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input
                  type="password"
                  id="newPassword"
                  placeholder="••••••••"
                  minlength="6"
                />
              </div>

              <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input
                  type="password"
                  id="confirmPassword"
                  placeholder="••••••••"
                  minlength="6"
                />
              </div>

              <div class="grid-2">
                <button type="submit" class="btn btn-primary">
                  Update Profile
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="changePassword()"
                >
                  Change Password
                </button>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:5000/api"
          : "https://novabuk-backend.onrender.com/api";
      let authToken = localStorage.getItem("authToken");
      let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
      let editingBlogId = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        if (authToken && currentUser) {
          showDashboard();
          loadBlogs();
          loadProfile();
        } else {
          showLoginPage();
        }

        // Event listeners
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("registerForm")
          .addEventListener("submit", handleRegister);
        document
          .getElementById("blogForm")
          .addEventListener("submit", handleBlogSubmit);
        document
          .getElementById("profileForm")
          .addEventListener("submit", handleProfileSubmit);
        document
          .getElementById("registerToggle")
          .addEventListener("click", toggleForms);
        document
          .getElementById("loginToggle")
          .addEventListener("click", toggleForms);
      });

      // Toggle between login and register forms
      function toggleForms(e) {
        e.preventDefault();
        document.getElementById("loginForm").classList.toggle("hidden");
        document.getElementById("registerForm").classList.toggle("hidden");
      }

      // Show sections
      function showSection(section) {
        // Hide all sections
        document.getElementById("blogsSection").classList.add("hidden");
        document.getElementById("createBlogSection").classList.add("hidden");
        document.getElementById("profileSection").classList.add("hidden");

        // Remove active class from all menu links
        document
          .querySelectorAll(".menu-link")
          .forEach((link) => link.classList.remove("active"));

        // Show selected section and update page title
        switch (section) {
          case "blogs":
            document.getElementById("blogsSection").classList.remove("hidden");
            document.getElementById("pageTitle").textContent = "Blog Posts";
            document
              .querySelector("[onclick=\"showSection('blogs')\"]")
              .classList.add("active");
            loadBlogs();
            break;
          case "createBlog":
            // Only reset form when not currently editing a loaded blog
            if (!editingBlogId) {
              document.getElementById("blogForm").reset();
              document.getElementById("blogId").value = "";
              document.getElementById("formTitle").textContent =
                "Create New Blog Post";
              document.getElementById("pageTitle").textContent =
                "New Blog Post";
            } else {
              // If editingBlogId is set, assume edit flow will set form values and title
              document.getElementById("pageTitle").textContent =
                "Edit Blog Post";
            }
            document
              .getElementById("createBlogSection")
              .classList.remove("hidden");
            const createLink = document.querySelector(
              "[onclick=\"editingBlogId=null; showSection('createBlog')\"]",
            );
            if (createLink) createLink.classList.add("active");
            break;
          case "profile":
            document
              .getElementById("profileSection")
              .classList.remove("hidden");
            document.getElementById("pageTitle").textContent = "Admin Profile";
            document
              .querySelector("[onclick=\"showSection('profile')\"]")
              .classList.add("active");
            loadProfile();
            break;
        }
      }

      // Show login page
      function showLoginPage() {
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("loginPage").classList.remove("hidden");
      }

      // Show dashboard
      function showDashboard() {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
      }

      // Handle login
      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const response = await fetch(`${API_URL}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.token;
            currentUser = data.admin;
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showAlert("Login successful!", "success", "loginAlert");
            setTimeout(() => {
              showDashboard();
              loadBlogs();
            }, 500);
          } else {
            showAlert(data.message || "Login failed", "error", "loginAlert");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error", "loginAlert");
        }
      }

      // Handle register
      async function handleRegister(e) {
        e.preventDefault();
        const name = document.getElementById("registerName").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        try {
          const response = await fetch(`${API_URL}/admin/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password }),
          });

          const data = await response.json();

          if (data.success) {
            // store token and create a minimal currentUser object
            authToken = data.token;
            currentUser = { name, email, role: "admin" };
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));

            showAlert(
              "Admin account created! Redirecting...",
              "success",
              "loginAlert",
            );

            // Reset forms and show dashboard (we already have a token)
            setTimeout(() => {
              document.getElementById("loginForm").reset();
              document.getElementById("registerForm").reset();
              showDashboard();
              loadBlogs();
              loadProfile();
            }, 500);
          } else {
            showAlert(
              data.message || "Registration failed",
              "error",
              "loginAlert",
            );
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error", "loginAlert");
        }
      }

      // Load blogs
      async function loadBlogs() {
        try {
          const response = await fetch(`${API_URL}/blogs/admin/all`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();

          if (data.success) {
            const blogsTable = document.getElementById("blogsTable");
            blogsTable.innerHTML = "";

            if (data.data.length === 0) {
              blogsTable.innerHTML =
                '<tr><td colspan="5" style="text-align: center; padding: 40px;">No blog posts yet. <a href="#" onclick="editingBlogId=null; showSection(\'createBlog\')" style="color: #35bac9;">Create one now</a></td></tr>';
              return;
            }

            data.data.forEach((blog) => {
              const row = document.createElement("tr");
              const status = blog.published ? "Published" : "Draft";
              const statusClass = blog.published
                ? "status-published"
                : "status-draft";
              const publishedDate = blog.publishedAt
                ? new Date(blog.publishedAt).toLocaleDateString()
                : "Not published";

              const publishBtn = blog.published
                ? ""
                : `<button class="btn btn-primary" onclick="publishBlog('${blog._id}')"><i class="fas fa-upload"></i> Publish</button>`;

              row.innerHTML = `
                      <td><strong>${blog.title}</strong></td>
                      <td>${blog.category}</td>
                      <td><span class="status-badge ${statusClass}">${status}</span></td>
                      <td>${publishedDate}</td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn btn-secondary" onclick="editBlog('${blog._id}')"><i class="fas fa-edit"></i> Edit</button>
                          ${publishBtn}
                          <button class="btn btn-danger" onclick="deleteBlog('${blog._id}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                      </td>
                    `;
              blogsTable.appendChild(row);
            });
          } else {
            showAlert(data.message, "error");
          }
        } catch (error) {
          showAlert("Error loading blogs: " + error.message, "error");
        }
      }

      // Edit blog
      async function editBlog(blogId) {
        console.log("editBlog called with", blogId);
        try {
          const response = await fetch(`${API_URL}/blogs/admin/${blogId}`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          // Try to parse JSON, but fall back to text if not JSON
          let data = null;
          let textBody = null;
          try {
            data = await response.json();
          } catch (err) {
            try {
              textBody = await response.text();
            } catch (tErr) {
              textBody = null;
            }
          }

          if (response.ok && data && data.success) {
            const blog = data.data;
            editingBlogId = blog._id;
            console.log("loaded blog for edit, editingBlogId=", editingBlogId);

            document.getElementById("blogId").value = blog._id;
            document.getElementById("blogTitle").value = blog.title;
            document.getElementById("blogCategory").value = blog.category;
            document.getElementById("blogExcerpt").value = blog.excerpt;
            document.getElementById("blogContent").value = blog.content;
            document.getElementById("blogAuthor").value = blog.author;
            document.getElementById("blogAuthorRole").value = blog.authorRole;
            document.getElementById("blogImage").value = blog.image;
            if (blog.image) {
              try {
                showImagePreviewFromUrl(blog.image);
              } catch (e) {}
            }
            document.getElementById("blogReadTime").value = blog.readTime;
            document.getElementById("formTitle").textContent = "Edit Blog Post";

            showSection("createBlog");
          } else {
            const statusInfo = `${response.status} ${response.statusText}`;
            const serverMsg =
              data && data.message
                ? data.message
                : textBody || JSON.stringify(data) || "No response body";
            console.error("editBlog failed", {
              status: statusInfo,
              body: data || textBody,
            });
            showAlert(
              `Error loading blog: ${statusInfo} - ${serverMsg}`,
              "error",
            );
          }
        } catch (error) {
          console.error("editBlog error", error);
          showAlert("Error: " + error.message, "error");
        }
      }

      // Handle blog submission
      async function handleBlogSubmit(e) {
        e.preventDefault();
        console.log("handleBlogSubmit editingBlogId=", editingBlogId);

        const blogData = {
          title: document.getElementById("blogTitle").value,
          category: document.getElementById("blogCategory").value,
          excerpt: document.getElementById("blogExcerpt").value,
          content: document.getElementById("blogContent").value,
          author: document.getElementById("blogAuthor").value,
          authorRole: document.getElementById("blogAuthorRole").value,
          image: document.getElementById("blogImage").value,
          readTime: parseInt(document.getElementById("blogReadTime").value),
          published: false,
        };

        try {
          const method = editingBlogId ? "PUT" : "POST";
          const url = editingBlogId
            ? `${API_URL}/blogs/${editingBlogId}`
            : `${API_URL}/blogs`;

          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(blogData),
          });

          const data = await response.json();

          if (data.success) {
            showAlert(
              editingBlogId ? "Blog updated!" : "Blog saved as draft!",
              "success",
            );
            setTimeout(() => {
              editingBlogId = null;
              showSection("blogs");
            }, 1000);
          } else {
            showAlert(data.message || "Error saving blog", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Save and publish blog
      async function saveBlogAndPublish() {
        // First save the blog
        const blogData = {
          title: document.getElementById("blogTitle").value,
          category: document.getElementById("blogCategory").value,
          excerpt: document.getElementById("blogExcerpt").value,
          content: document.getElementById("blogContent").value,
          author: document.getElementById("blogAuthor").value,
          authorRole: document.getElementById("blogAuthorRole").value,
          image: document.getElementById("blogImage").value,
          readTime: parseInt(document.getElementById("blogReadTime").value),
          published: false,
        };

        try {
          const method = editingBlogId ? "PUT" : "POST";
          const url = editingBlogId
            ? `${API_URL}/blogs/${editingBlogId}`
            : `${API_URL}/blogs`;

          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(blogData),
          });

          const data = await response.json();

          if (data.success) {
            const blogId = editingBlogId || data.data._id;

            // Then publish it
            const publishResponse = await fetch(
              `${API_URL}/blogs/${blogId}/publish`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${authToken}`,
                },
                body: JSON.stringify({ published: true }),
              },
            );

            const publishData = await publishResponse.json();

            if (publishData.success) {
              showAlert("Blog published successfully!", "success");
              setTimeout(() => {
                editingBlogId = null;
                showSection("blogs");
              }, 1000);
            } else {
              showAlert("Blog saved but error publishing", "error");
            }
          } else {
            showAlert(data.message || "Error", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Delete blog
      async function deleteBlog(blogId) {
        if (!confirm("Are you sure you want to delete this blog post?")) return;

        try {
          const response = await fetch(`${API_URL}/blogs/${blogId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();

          if (data.success) {
            showAlert("Blog deleted successfully!", "success");
            loadBlogs();
          } else {
            showAlert(data.message || "Error deleting blog", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Publish blog (quick action from list)
      async function publishBlog(blogId) {
        if (!confirm("Publish this blog post?")) return;

        try {
          const publishResponse = await fetch(
            `${API_URL}/blogs/${blogId}/publish`,
            {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({ published: true }),
            },
          );

          const publishData = await publishResponse.json();

          if (publishData.success) {
            showAlert("Blog published successfully!", "success");
            loadBlogs();
          } else {
            showAlert(publishData.message || "Error publishing blog", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Load profile
      async function loadProfile() {
        try {
          const response = await fetch(`${API_URL}/admin/me`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();

          if (data.success) {
            document.getElementById("profileName").value = data.data.name;
            document.getElementById("profileEmail").value = data.data.email;
            document.getElementById("profileRole").value = data.data.role;
          }
        } catch (error) {
          showAlert("Error loading profile", "error");
        }
      }

      // Handle profile submit
      async function handleProfileSubmit(e) {
        e.preventDefault();

        const profileData = {
          name: document.getElementById("profileName").value,
          email: document.getElementById("profileEmail").value,
        };

        try {
          const response = await fetch(`${API_URL}/admin/profile`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(profileData),
          });

          const data = await response.json();

          if (data.success) {
            showAlert("Profile updated!", "success");
          } else {
            showAlert(data.message || "Error", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Change password
      async function changePassword() {
        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (!currentPassword || !newPassword) {
          showAlert("Please enter current and new password", "error");
          return;
        }

        if (newPassword !== confirmPassword) {
          showAlert("Passwords do not match", "error");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/admin/change-password`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ currentPassword, newPassword }),
          });

          const data = await response.json();

          if (data.success) {
            showAlert("Password changed!", "success");
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
          } else {
            showAlert(data.message || "Error", "error");
          }
        } catch (error) {
          showAlert("Error: " + error.message, "error");
        }
      }

      // Logout
      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("currentUser");
          authToken = null;
          currentUser = null;
          showLoginPage();
          document.getElementById("loginForm").reset();
          document.getElementById("registerForm").reset();
        }
      }
      // File upload (Cloudinary)
      // Dev fallback: read cloud name from meta tag if present
      try {
        const metaCloud = document.querySelector(
          'meta[name="cloudinary-cloud-name"]',
        );
        if (metaCloud && metaCloud.content) {
          window.CLOUDINARY_CLOUD_NAME =
            window.CLOUDINARY_CLOUD_NAME || metaCloud.content;
        }
      } catch (e) {}
      document
        .getElementById("blogFile")
        .addEventListener("change", handleFileSelect);

      async function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Preview
        const preview = document.getElementById("uploadPreview");
        preview.innerHTML = "";
        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style.maxWidth = "200px";
          img.style.maxHeight = "150px";
          preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
          const vid = document.createElement("video");
          vid.src = URL.createObjectURL(file);
          vid.controls = true;
          vid.style.maxWidth = "200px";
          vid.style.maxHeight = "150px";
          preview.appendChild(vid);
        }

        try {
          const result = await uploadToCloudinary(file);
          if (result && result.secure_url) {
            const url = result.secure_url;
            document.getElementById("blogImage").value = url;
            // show cache-busted preview for hosted images
            try {
              showImagePreviewFromUrl(url);
            } catch (e) {}
            showAlert("Upload successful", "success");
          } else {
            showAlert("Upload failed", "error");
          }
        } catch (err) {
          console.error("Upload error", err);
          showAlert("Upload error: " + (err.message || err), "error");
        }
      }

      async function uploadToCloudinary(file) {
        if (!authToken) throw new Error("Not authenticated");

        // Request signing info or upload preset from backend
        const signRes = await fetch(`${API_URL}/uploads/cloudinary/sign`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authToken}`,
          },
        });
        const signData = await signRes.json();
        if (!signData.success)
          throw new Error(signData.message || "Could not get upload info");

        // Allow backend to provide a full upload URL (upload_url) or the cloud name
        const providedUploadUrl = signData.upload_url || signData.uploadUrl;
        const cloudName =
          signData.cloud_name ||
          signData.cloudName ||
          window.CLOUDINARY_CLOUD_NAME;

        let uploadUrlBase = providedUploadUrl || null;
        if (!uploadUrlBase) {
          if (cloudName) {
            uploadUrlBase = `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`;
          } else {
            // Provide clearer guidance for configuration
            throw new Error(
              "Cloudinary cloud name not configured on server (CLOUDINARY_CLOUD_NAME).\n" +
                "Please set CLOUDINARY_CLOUD_NAME on the server, or return `upload_url` from /uploads/cloudinary/sign,\n" +
                "or set `window.CLOUDINARY_CLOUD_NAME` in the client for local testing.",
            );
          }
        }

        const formData = new FormData();
        formData.append("file", file);

        if (signData.unsigned) {
          if (!signData.upload_preset)
            throw new Error(
              "Unsigned upload requires `upload_preset` from server",
            );
          formData.append("upload_preset", signData.upload_preset);
          return await uploadWithXhr(uploadUrlBase, formData);
        } else {
          if (signData.api_key) formData.append("api_key", signData.api_key);
          if (signData.timestamp)
            formData.append("timestamp", signData.timestamp);
          if (signData.signature)
            formData.append("signature", signData.signature);
          return await uploadWithXhr(uploadUrlBase, formData);
        }
      }

      function uploadWithXhr(url, formData) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", url);

          const progressWrap = document.getElementById("uploadProgress");
          const progressBar = document.getElementById("uploadProgressBar");
          progressWrap.style.display = "block";

          xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              progressBar.value = percent;
            }
          };

          xhr.onload = function () {
            progressWrap.style.display = "none";
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const res = JSON.parse(xhr.responseText);
                resolve(res);
              } catch (err) {
                reject(err);
              }
            } else {
              reject(
                new Error(
                  "Upload failed: " +
                    xhr.status +
                    " " +
                    xhr.statusText +
                    " - " +
                    xhr.responseText,
                ),
              );
            }
          };

          xhr.onerror = function () {
            progressWrap.style.display = "none";
            reject(new Error("Network error during upload"));
          };

          xhr.send(formData);
        });
      }

      // Display a preview for an image/video URL. Adds a cache-busting query param
      // so that newly uploaded/updated images hosted on CDN are fetched fresh.
      function showImagePreviewFromUrl(url) {
        if (!url) return;
        const preview = document.getElementById("uploadPreview");
        if (!preview) return;
        preview.innerHTML = "";
        // add cache buster
        const sep = url.includes("?") ? "&" : "?";
        const src = url + sep + "cb=" + Date.now();

        if (/(\.mp4|\.webm|\.ogg)(\?|$)/i.test(url) || url.includes("video")) {
          const vid = document.createElement("video");
          vid.src = src;
          vid.controls = true;
          vid.style.maxWidth = "200px";
          vid.style.maxHeight = "150px";
          preview.appendChild(vid);
        } else {
          const img = document.createElement("img");
          img.src = src;
          img.style.maxWidth = "200px";
          img.style.maxHeight = "150px";
          preview.appendChild(img);
        }
      }

      // Sidebar toggle behaviour for mobile: open/close and overlay handling
      (function () {
        const sidebar = document.querySelector(".sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarOverlay = document.getElementById("sidebarOverlay");

        if (!sidebar || !sidebarToggle || !sidebarOverlay) return;

        function openSidebar() {
          sidebar.classList.add("open");
          sidebarOverlay.classList.add("active");
          const icon = sidebarToggle.querySelector("i");
          if (icon) {
            icon.classList.remove("fa-bars");
            icon.classList.add("fa-xmark");
          }
        }

        function closeSidebar() {
          sidebar.classList.remove("open");
          sidebarOverlay.classList.remove("active");
          const icon = sidebarToggle.querySelector("i");
          if (icon) {
            icon.classList.remove("fa-xmark");
            icon.classList.add("fa-bars");
          }
        }

        function toggleSidebar() {
          if (sidebar.classList.contains("open")) closeSidebar();
          else openSidebar();
        }

        sidebarToggle.addEventListener("click", function (e) {
          e.preventDefault();
          toggleSidebar();
        });

        // Close when clicking overlay
        window.closeSidebarOnOverlay = function () {
          closeSidebar();
        };

        // Close on nav selection (mobile) for smoother UX
        document.querySelectorAll(".menu-link").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth <= 768) closeSidebar();
          });
        });
      })();

      // Show alert
      function showAlert(message, type, elementId = "alertContainer") {
        const alertContainer = document.getElementById(elementId);
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        setTimeout(() => alert.classList.add("show"), 10);

        setTimeout(() => {
          alert.classList.remove("show");
          setTimeout(() => alert.remove(), 300);
        }, 5000);
      }
    </script>
  </body>
</html>
